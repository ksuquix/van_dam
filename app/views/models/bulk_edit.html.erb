<h1>Bulk Edit Models</h1>
<% if @tag %>
  <p class="lead">Tagged with &quot;<%= @tag %>&quot;</p>
<% end %>

<%= form_with url: update_models_path, method: :patch do |form| %>

  <h3>Select models to change:</h3>

  <table class="table table-striped" data-bulk-edit>
    <tr>
      <th><input type="checkbox" aria-label="Select All" value="0" name="bulk-select-all"></th>
      <th>Name</th>
      <th>Collections</th>
      <th>Tags</th>
      <th>Creator</th>
      <th>Organize files</th>
    </tr>
    <% @models.each do |model| %>
      <tr>
        <td><%= form.check_box "models[#{model.id}]", { data: { bulk_item:  "#{model.id}"}}%></td>
        <td><%= link_to model.name, [model.library, model], title: model.path %></td>
        <td><%= render partial: 'tag', collection: model.collections.sort_by(&:name).sort_by(&:taggings_count), locals: {state: :normal, model_id: model.id } %></td>
        <td><%= render partial: 'tag', collection: model.tags.sort_by(&:name).sort_by(&:taggings_count), locals: {state: :normal, model_id: model.id } %></td>
        <td><%= link_to model.creator.name, model.creator if model.creator %></td>
        <td><code><%= model.formatted_path if model.formatted_path != model.path %></code></td>
      </tr>
    <% end %>
  </table>

  <h3>Select changes to make:</h3>

  <div class="row mb-3">
    <%= form.label :creator_id, class: "col-sm-2 col-form-label" %>
    <div class="col-sm-10">
      <div class="input-group">
        <%= form.collection_select :creator_id, @creators, :id, :name, {include_blank: true}, {class: "form-control col-auto form-select"} %>
        <%= link_to "New Creator", new_creator_path, class: "btn btn-outline-secondary col-auto" %>
      </div>
    </div>
  </div>

  <div class="row mb-3">
    <%= form.label :new_library_id, class: "col-sm-2 col-form-label" %>
    <div class="col-sm-10">
      <%= form.collection_select :new_library_id, Library.all, :id, :name, {include_blank: true}, {class: "form-control col-auto form-select"} %>
    </div>
  </div>

  <%= render 'tags_edit', :form => form, :name => :add_tags, :value => "", :label => "Add Tags", tags:  @addtags || [] %>
  <%= render 'tags_edit', :form => form, :name => :remove_tags, :value => "", :label => "Remove Tags", tags: @models.includes(:tags).map(&:tags).flatten.uniq.sort_by(&:name) %>

  <div class="row mb-3 input-group">
    <%= form.label :collections, class: "col-sm-2 col-form-label" %>
    <%= form.collection_select :collection_list, ActsAsTaggableOn::Tag.for_context(:collections),
      :name, :name, {}, {
        multiple: true,
        class: "form-select",
        data: {selectize: "true"}
      }
    %>
  </div>

  <div class="row mb-3">
    <%= form.label "Organize files", class: "col-sm-2 col-form-label" %>
    <div class="col-sm-10">
      <div class="form-switch">
        <%= form.check_box :organize, class: "form-check-input form-check-inline" %>
      </div>
    </div>
  </div>

  <%= form.hidden_field :tag, value: @tag if @tag %>
  <%= form.hidden_field :q, value: params[:q] if params[:q] %>
  <%= form.hidden_field :collection, value: params[:collection] if params[:collection] %>
  <%= form.hidden_field :library, value: params[:library] if params[:library] %>
  <%= form.hidden_field :creator, value: params[:creator] if params[:creator] %>
  <%= form.submit "Update Selected Models", class: "btn btn-primary" %>

<% end %>
